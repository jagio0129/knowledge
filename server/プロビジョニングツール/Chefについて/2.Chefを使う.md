# Chefを使う

## Chefクライアントのインストール

Chefはまだ歴史の浅いソフトウェアということもあり、ディストリビューションの公式パッケージとしては提供されていない場合が多い。また、提供されていてもそのバージョンが古いという場合もある。たとえばDebianでは安定版/不安定版の両方でパッケージが提供されているものの、提供されているのは現在の最新版であるバージョン11系（2013年8月現在でバージョン11.6.0）ではなく、その1つ前であるバージョン10系だ。

そのため、最新版を利用したい場合はRubyのパッケージ管理システムであるRubyGemsを使ってChefクライアントを含む「chef」パッケージをインストールするのがおすすめだ。

CentOSの場合、RubyGemsを利用するにはRubyだけでなく、rubygemsパッケージのインストールが必要だ。そのほか、バイナリのビルドのためにruby-develやgcc、makeといったパッケージも必要となる。これらは次のようにyumコマンドでインストールできる。

```
# yum install ruby ruby-devel rubygems make gcc
```

gem installでChefクライアントをふくむchefパッケージをインストールする。

```
$ gem install chef
```

これでRecipeを実行するchef-soloコマンドやCookbook管理ツールであるknifeコマンドなどが利用できるようになる。

## リポジトリとCookbookの作成

Chefでは、**Cookbookなどのリソースを格納するディレクトリを「リポジトリ」** と呼ぶ。 まず適当なディレクトリにリポジトリとして使用するディレクトリを作成する。

```
$ mkdir chef-repo
```

リポジトリ内にCookbookを格納するディレクトリを作成する。

```
$ mkdir chef-repo/cookbooks
```

Cookbookはテキストファイルとディレクトリから構成される。手動で作成することも可能だが、`knife cookbook create <Cookbook名>`」コマンドを利用することでその雛形を自動生成できる。例えば「setup-user」というCookbookを作成するには

```
$ cd chef-repo/cookbooks
$ knife cookbook create setup-user -o .
```

knifeコマンドの「-o」オプションは、Cookbookを作成するディレクトリを指定するための物。ここでは「.」を指定してカレントディレクトリに作成するように指示している。なお、これを省略した場合は「/var/chef/cookbooks/」以下にCookbookが作成される。

## Cookbookの構造

「knife cookbook create」コマンドで作成されたCookbookには、表１のようなディレクトリ及びファイルが用意される。

ファイル/ディレクトリ名 | 説明
:----------- | :------------------------------------------------------------
CHANGELOG.md | Cookbookの変更履歴を記述する
README.md    | Cookbookの概要などを記述する
attributes   | Cookbookで使用するデフォルトのAttributeを記述したファイルを格納するディレクトリ
definitions  | 「Definirion」と呼ばれる、リソースを組み合わせて新たなリソースを作成するための設定ファイルを格納するディレクトリ
files        | Cookbookないで利用されるファイルを格納するディレクトリ
libraries    | 「Library」と呼ばれる、Chefの機能を拡張するためのRubyコードを格納するディレクトリ
metadata.rb  | Cookbookに関する情報（メタデータ）を記述するファイル
providers    | 「Provider」と呼ばれる、リソースに対する処理を実行するための設定ファイルを格納するディレクトリ
recipes      | Recipe本体を格納するディレクトリ
resources    | 「Resource」と呼ばれる、Recipe内で使われる設定対象を定義するための設定ファイルを格納するディレクトリ
templates    | Cookbook内で利用されるテンプレートファイルを格納するディレクトリ

## ユーザー管理を行うRecipeを作成する

ここで作成するのは、指定したグループ及びユーザを作成するというもの。

Recipeは通常、knifeコマンドで作成されたCookbookのディレクトリ内にあるrecipesディレクリ内に記述する。このディレクトリ内に「default.rb」というファイルが作成されているはずなので、今回はこのファイルにRecipeの内容を記述していく。

Recipeの一般的な記述ルールは以下のとおり

```ruby
<リソースタイプ><リソース名> do
  <属性><その他>
  .
  .
  .
  action <リソースに対し実行するアクション>
end
```

**リソースタイプ** は、**設定対象とするリソースの種別を指定するもの。** 例えばユーザーが作成するなら「user」、グループを作成するなら「group」となる。

「**リソース名**」は、**設定対象とするリソースを識別するための名前。** この値はリソースタイプによって意味が異なるが、多くの場合はそのリソースの名前（たとえば設定対象がユーザ/グループであればそのユーザー名/グループ名、ファイルであればそのファイルパス、サービスであればそのサービス名）を指定する。

「**属性**」は、**そのリソースに対する設定値を指定するもので、また「action」はそのリソースに対してどのような処理（作成する、削除する、有効にする、無効にする、など）を実行するかを支持するものだ。** 属性やactionはリソースごとに指定できる値がことのあるので、実際にRecipeを作成する際はドキュメントを参照すること。

```ruby
#
# Cookbook Name:: setup-user
# Recipe:: default
#
# Copyright 2013, YOUR_COMPANY_NAME
#
# All rights reserved - Do Not Redistribute
#

group "taro" do
  gid 1000
  action :create
end

user "taro" do
  home "/home/taro"
  password '$6$OmC3KootOURrqOaP$63rwQ2bSE8op8wXa.ZWzgxm/iGvePTzEL5lOntmkPyYh5Qwh4lWs2DtyoEHcvsbYV5Q6a2ezzrZueb2ydrkhz0'
  shell "/bin/bash"
  uid 1000
  gid "taro"
  supports :manage_home => true
  action :create
end
```

ここではまず。「group」で「taro」というgroup型のリソースを定義している。actionには「:create」（リソースの作成）を指定し、「gid」属性ではグループIDを指定している。つまり、ここでしてした処理内容は**「taro」というグループを作成し、そのグループIDを1000とする**、と言うものになる。

続く「user」では、user型のリソースを定義している。user型のリソースもgroup型同様、リソース名が作成するユーザ名となる。また、ホームディレクトリやパスワード、利用するシェル、ユーザID、所属するグループなどの属性も指定している。なお、password属性の値にはハッシュ化したパスワードを指定する。ハッシュ化されたパスワードは「grub-crypt」コマンドで生成できる。

```
# grub-crypt –sha-512
Password: ←ハッシュ化したいパスワードを入力
Retype password: ←再度同じパスワードを入力
$6$OmC3KootOURrqOaP$63rwQ2bSE8op8wXa.ZWzgxm/iGvePTzEL5lOntmkPyYh5Qwh4lWs2DtyoEHcvsbYV5Q6a2ezzrZueb2ydrkhz0
↑ハッシュ化されたパスワードが表示される
```

なお、ChefのRecipeでは **ファイル内に記述した順番で処理が実行される。** そのため、userの設定よりも先にgroupの設定を記述しておく必要がある。

## chef-soloコマンド用の設定ファイルを作成する。

作成したCookbookは、chef-soloコマンドで実行できる。chef-soloコマンドの挙動はコマンドラインオプションのほか、設定ファイルで指定でき、そのパスはデフォルトでは/etc/chef/solo.rbファイルとなっている。このファイルは **自動的には作成されないので、手動で作成しておく必要がある。**

```
# mkdir /etc/chef
# vi /etc/chef/solo.rb
```
