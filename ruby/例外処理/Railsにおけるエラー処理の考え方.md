- エラーが起きた場合は「**原因を素早く特定し、速やかに復旧させること**」「**あるエラーが引き金になって、更に大きなエラーを引き起こさないようにすること**」が重要。
- エラー処理が不適切だと原因の特定に時間がかかったり、異常なデータがどんどん増えてさらに大きなエラーを引き起こしたりする。

## 正常系と異常系(エラー)を分類

### 正常系
正しい(想定している？)操作。正常系のテストと言った場合は背負う体通りの手順で動かして想定通りのアウトプットなり状態になるかをチェックする

### 異常系
エラーがでる操作。異常系のテストは不正な入力を検出したり、入力が正しくても何かしらの理由で途中コケた場合に正しくエラーを吐くなりの動作が行われるかをチェックする

簡単なユーザ登録処理を考える

1. メールアドレスとパスワードを入力する
1. 登録ボタンをクリックする
1. データベースにユーザのデータが登録される
1. マイページ画面が開く

上のような処理フローは「**正常系**」の処理フローである。
しかし、現実の運用では以下のような問題が発生する可能性もある。

- メールアドレスのフォーマットがおかしい
  - hoge@@gmail..comになっている
- データベースがダウンしている
- マイページ画面の実装にバグが有り、nilに対してeachを呼び出してしまった。
  - `NoMethodError: undefined method 'each' for nil:NilClass`が発生した

上のようなケースは「**異常系**」である。

## エラーを更に分類
上のようなエラーはさらに2つに分けることができる

### 業務エラー
- メールフォーマットがおかしい
「業務エラー」は業務設計の中で想定されている範囲内で処理が分岐、正常終了できなかった場合のエラーを指す。

入力値異常の他にも、以下のようなケースは業務エラーとして扱って良い。

- ユーザが権限のないページにアクセスしようとした場合
- すでに登録済みのユーザIDでアカウント登録しようとした場合

### システムエラー
- データベースがダウンしている
- マイページ画面の実装にバグが有る

「システムエラー」は **業務設計の想定範囲外の異常事態が発生し、処理を正常に遂行できなくなった場合のエラーを指す**

他にも以下のようなケースをシステムエラーとして扱って良い。
- データ以上やデータの不斉合成
  - 注文データに何故か注文日が保存されていない
  - 社員は必ず企業に属しているはずだが、ある社員のデータに関する企業が存在しない
- API連携の失敗
  - 決済サービスに対して課金処理を実行しようとしたが、決済サービスがダウンしていた。

##  業務エラーとシステムエラーの違い
業務エラーは簡単に言うと、ユーザが悪いと言えるエラー
システムエラーは、ユーザがどうにもできないエラーで、システムの運用者が責任をもって復旧させる必要がある。

## エラー処理に関する応用パターンやテストの実施方法

### 途中でエラーが発生しても続行したいケース
例えばメールの一斉送信を行ったりする場合、途中でエラーになるユーザがいてもそこで処理を中止せず、の頃のユーザにメールを送信したい。
こういう場合はエラーをrescueして、処理を続行する。

## 参考サイト
- [Railsアプリケーションにおけるエラー処理（例外設計）の考え方](http://qiita.com/jnchito/items/3ef95ea144ed15df3637)
